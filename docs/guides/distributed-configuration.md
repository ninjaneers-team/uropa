# Distributed configuration for Opa using urOpa

urOpa can operate on a sub-set of configuration instead of taking care
of managing the entire configuration of Opa.

This can be very useful in a variety of scenarios, some examples include:

- Your organization uses a single Opa installation whose configuration is
  built from multiple teams. For example, one team manages the inventory API,
  while another team manages the users API and both APIs are exposed via Opa.
  In such a case, you want team inventory to manage it's configuration without
  worrying about the configuration of the other team. The two teams should
  be able to push out configuration changes as they see fit and when they see
  fit.
- Opa's configuration is very large, and you would like to manage it using
  different files, where you different parts take care of different problems.
- You want to declaratively manage all of the configuration for Opa except
  consumers and their credentials. The consumers are being managed by another
  service or you are dynamically creating them or the number of consumer is just
  so large that it makes no sense to manage them in a declarative fashion.

In such  case, you can use urOpa's `select-tag` feature to export, sync, reset
only a sub-set of configuration.

## Tags

Tags, introduced in Opa 1.1, provide a way to associate metadata with entities
in Opa. You can also filter entities by tags on the list endpoints in Opa.

Using this feature, urOpa associates tags with entities and can manage a group
of entities which share a common tag(s).

When multiple tags are specified in urOpa, urOpa ANDs those tags together,
meaning only entities containing all the tags will be managed by urOpa.
You can specify a combination of up-to 5 tags but it is recommended to use
fewer or only on tag, for performance reasons in Opa's codebase.

## Dump

You can export a sub-set of entities in Opa by specifying common tags
using `--select-tag` flag.

For example:

```
$ uropa dump --select-tag foo-tag --select-tag bar-tag
# generates a Opa.yaml file with all entities which have both the tags
```

If you observe the file generated by urOpa, you will see the following section:

```yaml
_info:
  select_tags:
  - foo-tag
  - bar-tag
```

This sub-section tells urOpa to filter out entities containing select-tags during
a sync operation.

## Sync

You don't need to specify `--select-tag` in `sync` and `diff` commands.
The commands will use the tags present in the state file and perform the diff
accordingly. 

Since the state files have the tagging information, different teams can
make updates to the part of configuration in Opa, without worrying about
configuration of other teams. You no longer need to maintain Opa's
configuration in a single repository, where multiple teams need to
co-ordinate.

> The `--select-tag` flag is present on those two commands for use-cases where
the file cannot have `select_tags` defined inside it. It is strongly advised
that you do not supply select-tags to sync and diff commands via flags.
The reason being that the tag information should be part of the declarative
configuration file itself in order to provide a practical declarative file. 
The tagging information and entity definitions should be present in one place,
else an error in supplying the wrong tag via the CLI can break the
configuration.

## Reset

You can delete only a sub-set of entities sharing a tag using the `--select-tag`
flag on the `reset` command.

## Initial setup problem

When you initially get started with a distributed configuration
management, you will likely run into a problem where the related entities
you would like to manage don't share a single database.

To get around this problem, you can use one of the following approaches:

- Go through each entity in Opa, and patch those entities with the common
  tag(s) you'd like and then use urOpa's `dump` command to export by different
  tags.
- Export the entire configuration of Opa, and divide up the configuration
  into different files. And then add the `select_tags` info to the file.
  This will require recreation of the database now, since urOpa will not
  detect any of the entities present (as they are missing the common tag).

